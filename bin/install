#!/usr/bin/env bash

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

. ${SCRIPT_DIR}/common.sh

install_MySQL() {
  local install_type=$1
  local MYSQL_VERSION=$2
  local install_path=$3

  set -e

  local MAJOR="$(echo $MYSQL_VERSION | cut -d. -f1)"

  tmp_download_dir=$(mktemp -d)

  URL="$(get_mysql_records \
    | grep -e "\"version\": *\"$MYSQL_VERSION\"" \
    | tr , '\n' \
    | awk -F\" '/"url"/{ print $4 }'
  )"

  # It's possible that multiple URLs will be returned, generally when
  # there are multiple architectures available for a given OS / MySQL version.
  # Try to match the native architecture, otherwise fall back to the first one
  if [[ "$(echo $URL | wc -w)" -ne 1 ]]; then
    # Try to choose the arch-specific version
    ARCH_URL="$(echo $URL | tr ' ' '\n' | grep $(uname -m))"
    if [[ -z "$ARCH_URL" ]]; then
      ARCH_URL="$(echo $URL | cut -d' ' -f1)"
    fi
    URL="${ARCH_URL}"
  fi

  if [[ -z "$URL" ]]; then
    echo "No URL found for ${MYSQL_VERSION}. Did you choose one from list-all?"
    return 1
  fi

  FILENAME="$(basename $URL)"

  curl -sLo "${tmp_download_dir}/${FILENAME}" "${URL}"

  # running this in a subshell
  # because we don't want to disturb current working dir
  (
    cd $tmp_download_dir
    # MySQL randomly introduced a "-minimal" version for linux, so use
    # the largest target
    case "$( echo $FILENAME | awk -F. '{ print $NF }')" in
      gz)
        tar -xzf $FILENAME
        ;;
      xz)
        tar -xJf $FILENAME
        ;;
      zip)
        unzip -q $FILENAME
        ;;
    esac
    DIR="$(ls -l | grep ^d | awk '{ print $NF }')"

    # There's a choice here, if the file was source only or binary
    if [[ -f "${DIR}/CMakeLists.txt" ]]; then
        cd "${DIR}/build"
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${install_path}" ..
        make -j 4 install
    elif [[ -f "${DIR}/configure" ]]; then
        cd "${DIR}"
        ./configure --prefix="${install_path}"
        make -j 4 install
    else
      [[ -d "${install_path}" ]] && rm -rf "${install_path}"
      mv "${DIR}" "${install_path}"
    fi
  )

  # Cleanup
  rm -rf $tmp_download_dir

  # Help
  echo "Successfully installed MySQL ${MYSQL_VERSION}"
  echo "To initialize a new database:"
  echo "  asdf global mysql ${MYSQL_VERSION}"
  echo "  export DATADIR=/path/to/data"
  case "$MAJOR" in
    5)
      echo "  mysql_install_db --datadir=\$DATADIR"
      echo "  mysql_secure_installation"
      ;;
    8)
      echo "  mysqld --initialize-insecure --datadir=\$DATADIR"
      echo "  mysql_ssl_rsa_setup --datadir=\$DATADIR"
      ;;
  esac
  echo "To run the server:"
  echo "  mysqld_safe --datadir=\$DATADIR"
  echo "To stop the server:"
  echo "  mysqladmin -u root shutdown"
}

if [[ -z "$ASDF_INSTALL_TYPE" ]]; then
  echo "This command should not be run directly, only via asdf"
  exit 1
fi

install_MySQL $ASDF_INSTALL_TYPE $ASDF_INSTALL_VERSION $ASDF_INSTALL_PATH
